# インテル® OpenVINO™ ツールキット Training Extensionを使ってみる

この内容は[公式レポジトリ](https://github.com/openvinotoolkit/training_extensions/blob/develop/web/GETTING_STARTED.md)を和訳し、かつ、ちょっとしたTipsを追記したものです。

## 使い方

このページでは、GUI版OpenVINO Training Extension(OTE)ツールの使い方を説明します。以下の手順を実行する前に必要なパッケージをインストールし、[インストールガイド] (README.md) を使用して docker コンテナをビルドしてください。

## 目次

- [データ](#data)
    - [データの配置](#data-location)
    - [データのアノテーション](#data-annotation-using-cvat)
    - [データセット生成](#dataset-creation)
- [物体検出](#object-detection)
    - [Fine-tuning](#fine-tuning)
    - [評価](#evaluation) 
- [カスタム物体検出](#custom-detection)   
- [既知の問題](#known-issues-and-problems)

## データ

### データの配置
1. まず、`<training_extensions>/web/data/assets` に学習用またはバリデーション用の画像の入ったフォルダごと格納します。画像は最低でも60枚は用意しておいてください。

    **注意** つまりGUIから画像をアップロードすることは出来ないため、SSHなどでサーバーにアクセスいただき、当該フォルダに直接SFTPなどでフォルダをアップロードください。

2. その後、GUIにもどり、トップ画面から物体検出タスクを選択するか、カスタム物体検出タスクを作成します(詳細は[カスタム物体検出セクション](#custom-detection)を参照してください)。
3. タスク画面内の上部の `Assets` タブをクリックすると、1.で格納したフォルダ名が表示されていることを確認ください。

**重要:** 無駄な重複を避けるために、`Assets` フォルダ内のフォルダの名前を変更しないでください。

### CVATを用いたデータのアノテーション
`Assets`タブでデータフォルダを確認できるようになったら、それをCVATに送ってアノテーションを行うことができます。
1. トレーニングや評価に利用したいフォルダの右上にある `Push to CVAT` ボタンを押します。読み込みに時間がかかる場合がありますのでご注意ください. 
2. フォルダのアイコンを押すと、アノテーションタスクと関連情報が表示されたCVATのページに移動します。

    **注意** ここでログインIDとパスワードを要求されますが、[インストール](README.md)時に指定したもの（デフォルトだとどちらもdjango）をご使用ください。

3. CVATの画面上でアノテーションを開始するには、ページ下部の `Jobs` をクリックしてください。
4. 左側のツールバーで矩形を選択して境界ボックスに注釈を付けることもできますし，より難しい形状に注釈を付けるには多角形を選択することもできます。処理を高速化するには、`N` のようなホットキーを使って新しい図形に注釈を付けたり、`F` のようなホットキーを使って次の画像に移動したりします。注釈が終わったら、保存ボタンを忘れずに押してください。

    **Tips** より詳しいCVATの使い方については[公式ドキュメント](https://github.com/openvinotoolkit/cvat/blob/develop/cvat/apps/documentation/user_guide.md)を参照ください。

**Tips** アノテーションを保存（ダンプ）して後で再利用することができます。CVATのタスクページでこれを行うには、`Action` -> `Dump annotations` -> `CVAT 1.1` を選択します。
同様に、タスクのアノテーションをアップロードするには、`Action` -> `Upload annotation` とアノテーションの種類を選択してください。

### データセットの生成
1. すべてのフォルダと対応するジョブのアノテーションが終わったら、OTEの画面の `Assets` タブに戻り，各フォルダアイコンの左上隅にある `Pull from CVAT` という黄色いボタンを押します。
2. 次に、使用したい各フォルダを `train` または `val` として分類し、トレーニングや評価に使用します。
3. すべてのステップが完了すると，ページ右上の `Build` がアクティブになるので、これを押すと，選択した画像と訓練/評価用の分布を持つデータセットが作成されます。このアクションでは、作成時のタイムスタンプを名前にしてビルド(データセット)を作成します。評価やFine Tuningに使用します。情報ページの右上隅にあるビルドのドロップダウンリストから、物体検出タスクごとに選択します。

    **重要** 適切なFine Tuningを行うためには、train部分とval部分の両方がデータセットに存在している必要があることに注意してください。もしデータ上で事前訓練モデルを評価したい場合は、val部分だけをデータセットに入れても構いません。

**重要** train部分やval部分の画像数が60枚未満の場合は，適切に作成・利用できないことを覚えておいてください。

## 物体検出
各物体検出タスクの情報ページでは、その簡単な説明、公開精度（Accuracy）と複雑さ（Complexity）の事前学習済みモデルの表、および、特定のタスクに最も適したモデルを選択するためのモデルの比較グラフを見ることができます。

### 評価
あなたのデータセットで事前学習モデルを評価するには，次のようにしてください．
 1. ページ右上のドロップダウン・リストから必要なビルド（データセット）のタイムスタンプを選択してください。
 2. モデルを選択し、`Evaluate`を押す。
 
### Fine Tuning
より良い結果を得るために、データを使用して特定のオブジェクトに対して事前にトレーニングされたモデルをFine Tuningすることができます。
1. モデルを選択して、`Fine Tuning`を押す。
2. モデルに名前を付け、必要なビルド（データセット）とエポック数を選択します。予測値が描かれたval画像を保存したい場合は、`Save annotated val images`を選択する。
3. 詳細設定を選択してバッチサイズを選択するとよいでしょう。バッチサイズの値を高くすると，より一般的なモデルを学習しやすくなり，精度が向上します．しかし、高すぎる値はメモリの問題を引き起こす可能性があります: `ERROR: Unexpected bus error encountered in worker. これは共有メモリ(shm)が不足していることが原因かもしれません: `ERROR: ワーカーで予期せぬバスエラーが発生しました。
有効な最大バッチサイズを選択するために何度か試行したり、単に1とすることもできます。
4. トレーニングは少し遅れて開始されます。
5. トレーニング中は、ログやTensorboardグラフで進捗状況を確認することができます。

## カスタム物体検出
タスクに適した学習済みモデルが見つからなかった場合、カスタム検出タスクを作成することができます。この場合、画像から特徴を抽出することができる膨大な数のクラスで事前に訓練されたモデルを使用します。そのため、いくつかのエポックで微調整を行うことで、特定のクラスや希少なクラスを検出するためのモデルを訓練することができます。 
1. トップ画面の `カスタム検出タスクの作成' を選択する。
2. 検出したいクラスを含むすべての関連情報を入力する。
3. `<training_extensions>/web/data/assets` フォルダに画像を入れ、注釈を付けてビルドを作成する。
4. リストからモデルを選択し(小さなオブジェクトを検出するには、より複雑なモデルの方が良い)、Fine Tuningします。良い結果を得るためには、標準的な物体検出タスクよりも多くのエポックが必要になるかもしれないことを覚悟しておいてください。

## 学習後のモデルへのアクセス
現時点（2020年11月27日）では、GUIから学習済みモデルファイルへアクセスすることは出来ません。したがって、`<training_extensions>/web/data/problem/Object_Detection/<タスク名のフォルダ>/`の中から直接モデルファイルを取り出して後続のプロセスにて活用下さい。 

## 既知の問題
1. 学習用、バリデーション用の画像はそれぞれ60枚以上準備してください。
2. 水平方向のテキスト検出モデルをCPU上で評価およびFine Tuningすることができません。
